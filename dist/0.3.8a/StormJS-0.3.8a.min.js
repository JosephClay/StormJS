!function(root,_,undefined){var previousStorm=root.Storm,Storm=root.Storm={},console=console||{};console.log=console.log||function(){},console.error=console.error||console.log;var _exists=function(a){return null!==a&&a!==undefined},_stringFormat=function(){var a=new RegExp("{([^}])+}","g");return function(b,c){return b.replace(a,function(a,b){return c[b]||""})}}(),_.extend=function(){for(var a,b,c=arguments,d=c[0],e=1,f=c.length;f>e;e++){b=c[e];for(a in b)d[a]=b[a]}return d},STORM={};_.extend(STORM,{version:"0.0.1",name:"StormJS",category:{nonblocking:0,blocking:1}}),Storm.constants=function(){return STORM};var _mixin=function(a,b){return Storm[a]!==undefined?console.error(Storm.name+": Cannot mixin, "+a+" already exists: ",Storm[a]):(Storm[a]=b,void 0)};Storm.mixin=function(a,b){_.isString(a)&&_mixin(a,b);var c;for(c in a)_mixin(c,a[c])};var _uniqId=Storm.uniqId=function(){var a={};return function(b){b=b||"";var c=(a[b]||0)+1;return a[b]=c}}(),_uniqIdStr=Storm.uniqIdStr=function(a){return(a||"id")+""+_uniqId(a)},Extend=Storm.Extend=function(a,b){var c="function"==typeof a;c||(b=a);var d=this,e=function(){var b=d.apply(this,arguments);return c&&(b=a.apply(this,arguments)),b};_.extend(e,this);var f=function(){};return f.prototype=this.prototype,e.prototype=new f,_.extend(e.prototype,this.prototype,b),e.prototype.constructor=a||e,e},Events=Storm.Events=function(){var a=/\w([^:\.])*/g,b="signal",c=[].splice,d=function(){for(var a,b,c=arguments,d=c[0],e=1,f=c.length;f>e;e+=1){b=c[e];for(a in b)d[a]=b[a]}},e=function(){this._cache={},this._active={},this._inactive={},this._subid=0,this._subscriptions={}};e.construct=function(){return new e},e.extend=Extend,e.prototype={constructor:e,subscribe:function(a,c){var d=this._uniqueSubId(b),e=this._subscriptions[a]||(this._subscriptions[a]=[]);return c.__subid__=d,e.push(c),d},unsubscribe:function(a,b){var c=this._subscriptions[a];if(c){for(var d=0,e=c.length;e>d;d+=1)if(c[d].__subid__===b)return c.splice(d,1),!0;return!1}},dispatch:function(){for(var a,b=arguments,d=c.call(b,0,1)[0],e=this._subscriptions[d]||(this._subscriptions[d]=[]),f=0,g=e.length;g>f;f++)a=e[f],a&&a.apply(null,b)},disable:function(a){return this._inactive[a]=this._inactive[a]||{},this._inactive[a]=d({},this._active[a]),delete this._active[a],this},enable:function(a){return this._active[a]=this._active[a]||{},this._active[a]=d({},this._inactive[a]),delete this._inactive[a],this},on:function(a,b){var c,d,e=this._cache[a];return e?(c=e,d=this._getEventLocation(c)):(c=this._cache[a]=this._parseConfig(a),d=this._createEventLocation(c)),d.push(b),this},off:function(a){var b,c=this._cache[a];return b=c?c:this._cache[a]=this._parseConfig(a),b.hasNamespace?this._active[b.handle][b.evt][b.namespace].length=0:this._active[b.handle][b.evt]={"":[]},this},once:function(a,b){var c,d=!1;return this.on(a,function(){return function(){return d?c:(d=!0,c=b.apply(this,arguments),b=null,c)}})},trigger:function(){var a=arguments,b=c.call(a,0,1)[0],d=this._cache[b];eventConfig=d?d:this._cache[b]=this._parseConfig(b);var e=this._getEventLocation(eventConfig);if(!e)return this;if(eventConfig.hasNamespace)this._callEventArray(e,a);else{var f,g=this._active[eventConfig.handle][eventConfig.evt];for(f in g)this._callEventArray(g[f],a)}return this},listenTo:function(a,b,c){return a.on(b,c),this},stopListening:function(a,b){return a.off(b),this},_uniqueSubId:function(){return"s"+this._subid++},_callEventArray:function(a,b){b=b||[];for(var c,d=0,e=a.length;e>d;d+=1)if(c=a[d],c&&c.apply(null,b)===!1)return},_parseConfig:function(b){var c=-1!==b.indexOf(":")?!0:!1,d=-1!==b.indexOf(".")?!0:!1,e=b.match(a),f={};return c&&d?(f.handle=e[0],f.evt=e[1],f.namespace=e[2]):c&&!d?(f.handle=e[0],f.evt=e[1],f.namespace=""):d&&!c?(f.handle="",f.evt=e[0],f.namespace=e[1]):(f.handle="",f.evt=e[0],f.namespace=""),f.hasHandle=c,f.hasNamespace=d,f},_getEventLocation:function(a,b){b=b||this._active;var c=b[a.handle];if(c){var d=c[a.evt];if(d){if(!a.hasNamespace)return d;var e=d[a.namespace];if(e)return e}}},_createEventLocation:function(a,b){b=b||this._active;var c=b[a.handle]||(b[a.handle]={}),d=c[a.evt]||(c[a.evt]={}),e=d[a.namespace]||(d[a.namespace]=[]);return e},toString:function(){return"["+Storm.name+" Events]"}};var f=new e;return f.core=e,f}();_.extend(Storm,Events.core.construct());var Promise=Storm.Promise=function(){var a={idle:0,progressed:1,failed:2,done:3},b={done:0,fail:1,always:2,progress:3,pipe:4},c=_.invert(b),d=function(){this._calls={},this.status=a.idle};return d.STATUS=a,d.CALL=b,d.prototype={constructor:d,done:function(a){return this.pushCall.call(this,b.done,a)},fail:function(a){return this.pushCall.call(this,b.fail,a)},always:function(a){return this.pushCall.call(this,b.always,a)},progress:function(a){return this.pushCall.call(this,b.progress,a)},pipe:function(a){return this.pushCall.call(this,b.pipe,a)},pushCall:function(a,b){return this._getCalls(a).push(b),this},notify:function(){this.status=a.progressed;var c=this._runPipe(arguments);return this._fire(b.progress,c)._fire(b.always,c),this},reject:function(){return this.status=a.failed,this._fire(b.fail,arguments)._fire(b.always,arguments),this},resolve:function(){this.status=a.done;var c=this._runPipe(arguments);return this._fire(b.done,c)._fire(b.always,c),this},_fire:function(a,b){for(var c=this._getCalls(a),d=0,e=c.length;e>d;d++)c[d].apply(null,b);return this},_runPipe:function(a){for(var c,d=this._getCalls(b.pipe),e=0,f=d.length;f>e;e++)c=d[e].apply(null,a),c!==undefined&&(a=[c]);return a},_getCalls:function(){return this._calls[c[callType]]||(this._calls[c[callType]]=[])},call:function(){var a=_.toArray(arguments);a.splice(0,1),this.notify.apply(this,a)},apply:function(a,b){this.notify.apply(this,b)},toString:function(){return"["+Storm.name+" Promise]"}},d}(),When=Storm.when=function(a){var b=function(){this._p=null,this._events=[]};return b.prototype={constructor:b,init:function(){this._events=_.isArray(arguments[0])?arguments[0]:_.toArray(arguments),this._subscribe();var b=new a;return b.then=function(){this.done.apply(this,arguments)},this._p=b,b},_subscribe:function(){for(var a=this._checkStatus.bind(this),b=this._fireProgress.bind(this),c=this._events,d=c.length;d--;)c[d].done(a).fail(a).progress(b)},_checkStatus:function(){for(var b,c=this._events,d=c.length,e=0,f=0,g=d;g--;){if(b=c[g],b.status===a.STATUS.idle)return;b.status!==a.STATUS.done?b.status!==a.STATUS.failed||(f+=1):e+=1}this._fire(d,e,f,arguments)},_fire:function(b,c,d,e){var f=this._p;return c===b?f.resolve.apply(f,e):d===b?f.reject.apply(f,e):c+d===b?f._fire(a.CALL.always,e):void 0},_fireProgress:function(){var a=this._p;a.notify.apply(a,arguments)}},function(){var a=new b;return a.init.apply(a,arguments)}}(Promise);!function(){for(var a=0,b=["ms","moz","webkit","o"],c=0,d=b.length;d>c&&!root.requestAnimationFrame;c++)root.requestAnimationFrame=root[b[c]+"RequestAnimationFrame"],root.cancelAnimationFrame=root[b[c]+"CancelAnimationFrame"]||root[b[c]+"CancelRequestAnimationFrame"];root.requestAnimationFrame||(root.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=root.setTimeout(function(){b(c+d)},d);return a=c+d,e}),root.cancelAnimationFrame||(root.cancelAnimationFrame=function(a){clearTimeout(a)})}(),Storm.animate=function(){var a={},b=[],c=(root.requestAnimationFrame,null),d=!0;return _animate=function(){for(var a=0,d=b.length;d>a;)b[a](),a+=1;c=root.requestAnimationFrame(_animate)},_animate(),{hook:function(c){if(!_.isFunction(c))return console.error(Storm.name+": Parameter must be a function: ",c);var d=_uniqId("Animate");return a[d]=b.length,b.push(c),d},unhook:function(c){return b.splice(a[c],1),delete a[c],this},isRunning:function(){return this._isRunning},start:function(){return d?void 0:(d=!0,_animate(),this)},stop:function(){return d?(d=!1,root.cancelAnimationFrame(c),this):void 0}}}();var Xaja=function(root){var _getXHR=function(){return root.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")},_isVersion2=""===_getXHR().responseType,_now=function(a){return a.now?a.now:function(){return(new a).getTime()}}(Date),_invert=function(a){var b,c={};for(b in a)c[a[b]]=b;return c},_accepts={xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript",js:"application/javascript, text/javascript"},_JSON=root.JSON,_ArrayBuffer=root.ArrayBuffer,_Blob=root.Blob,_Document=root.Document,_FormData=root.FormData,_QUERY_REGEX=/\?/,_EVT={success:0,error:1,progress:2,complete:3},_EVT_NAME=_invert(_EVT),Request=function(a){this.xhr=a,this._e={}};Request.prototype={success:function(a){return a?(this._getRegistry(_EVT.success).push(a),this):this},done:function(a){return this.success(a)},error:function(a){return a?(this._getRegistry(_EVT.error).push(a),this):this},fail:function(a){return this._error(a)},progress:function(a){return a?(this._getRegistry(_EVT.progress).push(a),this):this},complete:function(a){return a?(this._getRegistry(_EVT.complete).push(a),this):this},always:function(a){return this.complete(a)},abort:function(){return this.xhr.abort(),this},_getRegistry:function(){return this._e[_EVT.complete]||(this._e[_EVT.complete]=[])},toString:function(){return"[Xaja]"}};var _requestTrigger=function(a,b){for(var c=this._e[a]||[],d=0,e=c.length;e>d;d++)c[d].apply(this.xhr,b||[]);this._e[a].length=0},_construct=function(a){a=a||{};var b,c=_createRequest(a);for(b in _EVT_NAME)c[b](a[_EVT_NAME[b]]);return c},_createRequest=function(a){var b=_getXHR(),c=a.method||"GET",d=a.url||"",e=a.dataObj||null,f="GET"===c,g=!f,h=a.async===undefined?!0:!!a.async,i=a.type?a.type.toLowerCase():a.dataType?a.dataType.toLowerCase():"text",j=_isSupportedType(b,i),k={"X-Requested-With":"XMLHttpRequest"},l="",m=_prepData(e,l,f),n="string"==typeof m,o=new Request(b);_cacheBust(l,a.cache),l&&(d+=(_QUERY_REGEX.test(d)?"&":"?")+l),_bindProgress(b,o),b.open(c,d,h,a.user||"",a.password||""),_isVersion2?b.onload=function(){_handleResponse(b,d,j,i,o)}:b.onreadystatechange=function(){4===b.readyState&&_handleResponse(b,d,j,i,o)},n&&g&&(k["Content-Type"]="application/x-www-form-urlencoded"),k.Accept=a.content?a.content:_accepts[i];var p;for(p in k)b.setRequestHeader(p,k[p]);return b.send(g?m:null),a.timeout&&(this.loadTimeout=setTimeout(function(){b.abort(),console.log("Loading timed out for: "+d+" timeout: "+a.timeout)},a.timeout)),o},_handleResponse=function(xhr,url,isTypeSupported,type,request){var response="",parseError="parseError",responseText="responseText",responseXML="responseXML";try{if(200!==xhr.status)throw new Error(xhr.status+" ("+xhr.statusText+")");if("text"===type||"html"===type)response=xhr[responseText];else if(isTypeSupported&&xhr.response!==undefined)response=xhr.response;else if("json"===type)try{response=_JSON?_JSON.parse(xhr[responseText]):eval("("+xhr[responseText]+")")}catch(e){throw new Error("Error while parsing JSON body")}else if("js"===type)response=eval(xhr[responseText]);else{if("xml"!==type)throw new Error("Unsupported type: "+type);if(!xhr[responseXML]||xhr[responseXML][parseError]&&xhr[responseXML][parseError].errorCode&&xhr[responseXML][parseError].reason)throw new Error("Error while parsing XML body");response=xhr[responseXML]}_requestTrigger.call(request,_EVT.success,[xhr,url,response])}catch(e){response='Request to "'+url+'" errored: '+e,_requestTrigger.call(request,_EVT.error,[xhr,url,response])}_requestTrigger.call(request,_EVT.complete,[xhr,url,response])},_isSupportedType=function(a,b){var c=!1;if(b&&_isVersion2)try{a.responseType=b,c=a.responseType===b}catch(d){}return c},_prepData=function(a,b,c){if(c&&(_ArrayBuffer&&a instanceof _ArrayBuffer||_Blob&&a instanceof _Blob||_Document&&a instanceof _Document||_FormData&&a instanceof _FormData))a=null;else{var d,e=[];for(d in a)e.push(encodeURIComponent(d)+"="+encodeURIComponent(a[d]));a=e.join("&")}return c&&(b+=a),a},_cacheBust=function(a,b){b||(a&&(a+="&"),a+="_="+_now())},_bindProgress=function(a,b){if(_isVersion2&&a.upload){var c=function(){_requestTrigger.call(b,_EVT.progress,arguments)};a.addEventListener("progress",c,!1),a.upload.addEventListener("progress",c,!1)}};return{ajax:_construct,get:function(a,b){return b=b||{},b.method="GET",b.url=a,_construct(b)},post:function(a,b){return b=b||{},b.method="POST",b.url=a,_construct(b)}}}(this),Request=Storm.request=function(){var a={},b=0,c=function(){Events.core.call(this);var a=this;this.on("abort",function(b,c,d,e,f){a.erase(f)})};return _.extend(c.prototype,Events.core.prototype,{constructor:c,record:function(c){var d=c.getConfiguration(),e=a[d.category]||(a[d.category]={});return e[c.getId()]?this:(e[c.getId()]=c,b++,this.trigger("record",c),this)},erase:function(c){var d=c.getConfiguration().category,e=c.getId();return a[d]&&a[d][e]&&(delete a[d][e],b--,this.trigger("erase",c)),this},getTotalQueued:function(){return b},addCategories:function(a){if(_.isString(a))return this.addCategory(a),this;var b=a;return _.each(b,function(){this.addCategory(a)}),this},addCategory:function(a){return STORM.category[a]!==undefined?console.error(Storm.name+': Cannot add category, "'+a+'" already exists: ',STORM.category[a]):(STORM.category[a]=_.size(STORM.category),this)},getCategories:function(){return a},getCategory:function(b){return a[b]},toString:function(){return"["+Storm.name+" Request]"}}),new c}(),DataContext=Storm.DataContext=function(a){var b=function(){this._id=_uniqId("DataContext")};return b.globalCallTemplate={},b.settings=function(){var a=root.location||{};return{host:a.host,hostname:a.hostname,origin:a.origin,pathname:a.pathname,port:a.port}}(),b.setup=function(a){_.extend(b.setting,a)},b.getSetting=function(a){return b.settings[a]},b.removeSetting=function(a){return b.settings[a]?(delete b.settings[a],!0):!1},b.prototype={constructor:b,defaults:{},options:{},callTemplate:{},getSetting:function(){return b.getSetting.apply(arguments)},removeSetting:function(){return b.removeSetting.apply(arguments)},extendOptions:function(a){return this.options=_.extend({},this.defaults,a),this},removeOption:function(a){return delete this.options[a],this},createCall:function(b,c){return new a(b,c,this.options)},toString:function(){return"["+Storm.name+" DataContext]"}},b}(AjaxCall),AjaxCall=function(){var a=function(a,b,c){this._id=_uniqId("AjaxCall"),this.call=this.configure(a,b,c),this.data=""};return a.prototype={constructor:a,defaults:{name:"",type:"GET",content:"application/json; charset=utf-8",url:"",cache:!1,category:STORM.category.nonblocking},configure:function(a,b,c){var d=_.extend({},this.defaults,DataContext.callTemplate,a),e=d.url;return e=this._urlMerger(e,_.extend({},DataContext.settings,c,b)),d.url=e,d._id=this._id,d},getConfiguration:function(){return this.call},getId:function(){return this._id},isType:function(a){return a.toUpperCase()===this.call.type.toUpperCase()},isCategory:function(a){return a.toUpperCase()===this.call.category.toUpperCase()},get:function(a){return this.call[a]},set:function(a,b){return this.call[a]=b,this},send:function(a){var b=this,c=this.call,d=this.request=Xaja.ajax({type:c.type,url:c.url,contentType:c.content,data:c.data||this.data,cache:c.cache,success:function(c){c=_exists(c)?c.d||c:null,a&&a.resolve(c),Storm.request.trigger("done",c,b)},error:function(c,d,e){return a&&a.reject(c),0===c.status?(Storm.request.trigger("abort",c,d,e,b),void 0):(Storm.request.trigger("fail",c,d,e,b),void 0)},complete:function(){Storm.request.trigger("always",b)}});return Storm.request.record(this),d.always(function(){Storm.request.erase(b)}),d},abort:function(){return this.request&&this.request.abort(),this},toString:function(){return"[Signal AjaxCall]"}},a}();Storm.template=function(){var a,b={},c={},d=function(a,c){if(!_.isString(a)){var f,g=a;for(f in g)d(f,g[f]);return this}if("#"===a[0]){var h=document.getElementById(a.substring(1,a.length));if(!h)return console.error(Storm.name+': Cannot find reference to "'+a+'" in DOM');c=h.innerHTML}return b[a]=e(c),this},e=function(a){return _.isFunction(a)&&(a=a.call()),_.isString(a)?a.trim():_.isArray(a)?a.join("\n").trim():(console.error(Storm.name+": Template (or the return value) was of unknown type"),void 0)},f=function(d){var e=c[d];return e?e:(a||console.error(Storm.name+": No template engine has been registered"),c[d]=a.compile(b[d]))},g=function(a){delete b[a],delete c[a]},h=function(a,b){var c=f(a);return c(b||{})};return{add:d,remove:g,render:h,setEngine:function(b){a=b},toJSON:function(a){var c=a?b[a]:b;return c},toString:function(){return"["+Storm.name+" template]"}}}();var View=Storm.View=function(){var a=function(a){Events.core.call(this),a=a||{},this._id=_uniqId("View"),this.elem=a.elem||null,this.template=this.template||a.template||""};return _.extend(a.prototype,Events.core.prototype,{constructor:a,render:function(){},getElem:function(){return this.elem||(this.elem=this.render())},remove:function(){return this.elem&&this.elem.remove(),this},toString:function(){return"["+Storm.name+" View]"}}),a}(),Model=Storm.Model=function(){var a=function(a,b){Events.core.call(this),this._id=_uniqId("Model"),this.__data={},this.options={},this.originalData={},this.previousData={},this.promises={},this.getters={},this.setters={},this._setup(a,b)};return _.extend(a.prototype,Events.core.prototype,{constructor:a,_setup:function(a){a=this._duplicate(a||{});var b=this.options.defaults||this.defaults,c=_.extend({},b,a);this.originalData=_.extend({},c),this.previousData=_.extend({},c),this.__data=_.extend({},c),this.comparator&&this.comparator.bind(this)},getId:function(){return this._id},getter:function(a,b){return _.isFunction(b)&&(this.getters[a]=b),this},setter:function(a,b){return _.isFunction(b)&&(this.setters[a]=b),this},get:function(){var a=this._parseGetSetArguments(arguments);if(this.getters[a.prop]){var b=this.getters[a.prop].call(null,this,this.__data[a.prop]);return b}return this.__data[a.prop]},set:function(){var a=this._parseGetSetArguments(arguments);return this.setters[a.prop]?(a.data=this.setters[a.prop].call(null,this,a.data),this._change(a),this):(this._change(a),this)},_parseGetSetArguments:function(a){var b=a[0];if(!_.isString(b)){var c,d;for(c in b)d=b[c];return{prop:c,data:d,settings:a[1]||{}}}return{prop:b,data:a[1],settings:a[2]||{}}},add:function(a,b,c){if(!_.isString(a)){var d;for(d in a){b=a[d],a=d;break}}this._add(a,b,c)},remove:function(a,b){this._remove(a,b)},previous:function(a){return this.previousData[a]},has:function(a){return a in this.__data},hasChanged:function(a){if(a)return this.originalData[a]===this.__data[a]?!1:!0;var b;for(b in this.__data)if(this.hasChanged(b))return!0;return!1},keys:function(){var a,b=[];for(a in this.__data)b.push(a);return b},values:function(){var a,b=[];for(a in this.__data)b.push(this.__data[a]);return b},clone:function(){return new this.constructor(this.__data,this.options)},_duplicate:function(a){return a!==undefined?JSON.parse(JSON.stringify(a)):undefined},retrieve:function(){return this.__data},_backup:function(){return this.previousData=this._duplicate(this.__data),this},_add:function(a,b,c){return this._backup(),this.__data[a]=this._duplicate(b),this.previousData[a]===this.__data[a]?this:c&&c.isSilent?this:(this.trigger(a+".add",b),this.trigger("model:add",a,b),void 0)},_remove:function(a,b){return this._backup(),delete this.__data[a],this.previousData[a]===undefined?this:b&&b.isSilent?this:(this.trigger(a+".remove"),this.trigger("model:remove",a),void 0)},_change:function(a){this._backup();var b=a.prop,c=this._duplicate(a.data);return this.__data[b]=c,_.isEqual(this.previousData[b],this.__data[b])?this:a.settings.isSilent?this:(this.trigger(b+".change",b,c),this.trigger("model:change",b,c),this.trigger("change:"+b,c),this)},compareTo:function(a){return this.comparator&&a?this.comparator.getSortValue(this).localeCompare(this.comparator.getSortValue(a)):console.log("Storm: no Comparator set, returning")},_validate:function(){if(!this.validate)return!0;var a=this.validate();return a||this.trigger("model:invalid"),a},toJSON:function(){return this.retrieve()},toString:function(){return"["+Storm.name+" Model]"}}),_.each(["each","size","toArray","pluck"],function(b){a.prototype[b]=function(){var a=_.toArray(arguments);return a.unshift(this.__data),_[b].apply(_,a)}}),a}(),Comparator=Storm.Comparator=function(){var a={alphabetical:0,numeric:1,date:2},b=function(b,c){this._key=b,this._type=c||a.alphabetical,this._store={}};return b.HOISTING_STR="___",b.SORT=a,b.prototype={constructor:b,bind:function(a){var b=this;a.on(this._key+".change",function(){b.invalidateSortValue(a)})},invalidateSortValue:function(a){return delete this.store[a.getId()],this},getSortValue:function(b){var c,d=b.getId();return this._store[d]?this._store[d]:(c=this._type===a.date?this.dateValue(b):this._type===a.numeric?this.numericValue(b):this.alphabeticalValue(b),this._store[d]=c,c)},alphabeticalValue:function(a){var c=a.get(this._key)||"";return c=c?c.toLocaleLowerCase():b.HOISTING_STR},numericValue:function(a){var b=a.get(this._key)||0;return b=+b},dateValue:function(a){var b=a.get(this._key)||new Date;return b=_.isDate(b)?b:new Date(b)},toString:function(){return"["+Storm.name+" Comparator]"}},b}(),Collection=Storm.Collection=function(a){var b=function(a){Events.core.call(this),a=a||{},this._id=_uniqId("Collection"),this._models=[],this.add(a.models,{isSilent:!0},a)};return _.extend(b.prototype,Events.core.prototype,{constructor:b,Model:a,getId:function(){return this._id},newModel:function(a,b,c){return new this.Model(a,b,c)},getModels:function(){return this._models},getBy:function(a,b){for(var c=this._models,d=c.length;d--;)if(c[d].get(a)===b)return c[d];return null},length:function(){return this._models.length},at:function(a){return this._models[a]},indexOf:function(a){for(var b=a.getId(),c=this._models,d=c.length;d--;)if(c[d].getId()===b)return d;return-1},set:function(a,b,c){c=c||this._models;for(var d=c.length;d--;)c[d].set(a,b)},add:function(a,b,c){a=_.isArray(a)?a.slice():[a],b=b||{};for(var d,e,f=0,g=a.length,h=[],i=b.at;g>f;f++)if(e=a[f],d=a[f]){if(d instanceof Storm.Model||(d=this.newModel(d,b,c)),!d._validate())return this.trigger("collection:invalid",d,a),this;if(this.get(d)){if(b.merge){for(var j in e)d.set(j,e[j],b);d.trigger("collection:merge")}}else h.push(d)}if(h.length&&(_exists(i)?this._models.splice([i,0].concat(h)):this._models.push(h),b.skipSort||this.sort({isSilent:!0})),b.isSilent)return this;var k=this;return this.each(function(a){a.trigger("collection:add",k)}),this.trigger("add",h,b),this},push:function(a,b){return b=_.extend({at:this._models.length},b),this.add(a,b),a},unshift:function(a,b){return b=_.extend({at:0},b),this.add(a,b),a},remove:function(a,b){a=_.isArray(a)?a.slice():[a],b=b||{};for(var c,d=0,e=a.length;e>d;d++)c=this.get(a[d]),c&&(this._models.splice(this.indexOf(c),1),b.isSilent||c.trigger("collection:remove",this));return b.isSilent?this:(this.trigger("remove",a,b),this)},shift:function(a){var b=this.at(0);return this.remove(b,a),b},pop:function(a){var b=this.at(this.length-1);return this.remove(b,a),b},slice:function(a,b){return this._models.slice(a,b)},sort:function(a){if(a=a||{},this._models.sort(function(a,b){return a.compareTo(b)}),!a.silent){var b=this;this.each(function(a,c){a.trigger("collection:sort",b,c)}),this.trigger("sort",this,a)}return this},get:function(a){return this._models[this.indexOf(a)]},where:function(a){return _.isEmpty(a)?[]:this.filter(function(b){for(var c in a)if(a[c]!==b.get(c))return!1;return!0})},pluck:function(a){return _.invoke(this._models,"get",a)},getModelById:function(a){for(var b=this._models,c=b.length-1;c>=0;c--)if(b[c].getId()===a)return b[c];return null},reset:function(a){return a=a||{},this._models.length=0,a.isSilent||this.trigger("reset"),this},clone:function(){return new this.constructor({model:this.model,models:this._models})},retrieve:function(){return _.map(this._models,function(a){return a.retrieve()})},toJSON:function(){return this.retrieve()},toString:function(){return"["+Storm.name+" Collection]"}}),_.each(["each","map","reduce","reduceRight","find","filter","select","reject","every","all","some","any","include","contains","invoke","size","first","initial","rest","last","without","indexOf","shuffle","lastIndexOf","isEmpty"],function(a){b.prototype[a]=function(){var b=_.toArray(arguments);return b.unshift(this._models),_[a].apply(_,b)}}),_.each(["groupBy","countBy","sortBy"],function(a){b.prototype[a]=function(b,c){var d=_.isFunction(b)?b:function(a){return a.get(b)};return _[a](this._models,d,c)}}),b}(Model),Module=Storm.Module=function(){var a=function(){Events.core.call(this),this._id=_uniqId("Module")};return _.extend(a.prototype,Events.core.prototype,{constructor:a,toString:function(){return"["+Storm.name+" Module]"}}),a}(),Cache=Storm.Cache=function(){var a=function(){this._id=_uniqId("Cache"),this._cache={},this._timeouts={}};return a.prototype={constructor:a,store:function(a,b,c){if(c=c||{},!_.isString(a)){c=b,b=a;var d;for(d in b)this._store(d,b[d],c)}return this._store(a,b,c),this},get:function(a){return this._cache[a]},remove:function(a){return this._clearExpiration(a),delete this._cache[a],this},flush:function(){return this._clearExpirations(),this._cache={},this},_store:function(a,b,c){if(_exists(c.expiration)){if(!_.isNumber(c.expiration))return console.error(Storm.name+": Cannot set expiration. Value is not a number: ",c.expiration);this._setExpiration(a,c.expiration)}if(c.extend){if(!_.isObject(this._cache[a]))return console.error(Storm.name+": Cannot extend store value. Value is not an object: ",c.extend);b=_.extend(this._cache[a],b)}this._cache[a]=b},_setExpiration:function(a,b){this._timeouts[a]&&clearTimeout(this._timeouts[a]);var c=this;this._timeouts[a]=setTimeout(function(){delete c._cache[a],delete c._timeouts[a]},_.isNaN(b)?0:b)},_clearExpirations:function(){var a;for(a in this._timeouts)this._clearExpiration(a)},_clearExpiration:function(a){clearTimeout(this._timeouts[a]),delete this._timeouts[a]},toJSON:function(a){var b=a?this.get(a):this._cache;return b},toString:function(){return"["+Storm.name+" Cache]"}},a}();Storm.cache=new Cache;var Storage=Storm.Storage=function(){var a={local:1,session:2},b=_.invert(a),c=function(c){this.type=c||a.local,this.name=b[this.type],this.storage=root[this.name+"Storage"],this.hasStorage=_exists(this.storage),this.data=this._getData(),this.length=this.hasStorage?this.storage.length:_.size(this.data)};return c.TYPE=a,c.prototype={constructor:c,clear:function(){return this.data={},this.length=0,this.hasStorage?(this.storage.clear(),this):(this._clearData(),this)},key:function(a){if(this.hasStorage)return this.storage.key(a);var b,c=0;for(b in this.data){if(c===a)return k;c++}return null},getItem:function(a){if(this.hasStorage){var b=this.storage.getItem(a);return _exists(b)?JSON.parse(b):b}return this.data[a]},get:function(a){return this.getItem(a)},setItem:function(a,b){if(_.isString(a)){if(this.hasStorage){var c=this.storage.setItem(a,JSON.stringify(b));return this.length=this.storage.length,c}this.data[a]=b,this.length++,this._setData()}else{var d;for(d in a)this.setItem(d,a[d])}},store:function(a,b){this.setItem(a,b)},set:function(a,b){this.setItem(a,b)},removeItem:function(a){if(this.hasStorage){var b=this.storage.removeItem(a);return this.length=this.storage.length,b}delete this.data[a],this.length--,this._setData()},remove:function(a){return this.removeItem(a),this},_createCookie:function(a){var b,d=this.type===c.TYPE.session?0:365,e=new Date;d>0?(e.setTime(e.getTime()+24*d*60*60*1e3),b=e.toGMTString()):b="0",document.cookie=_stringFormat("{name}={value}; expires={expiration}; path=/",{name:this.name,value:a,expiration:b})},_readCookie:function(){for(var a,b=this.name+"=",c=document.cookie.split(";"),d=0,e=c.length;e>d;d++){for(a=c[d];" "===a.charAt(0);)a=a.substring(1,a.length);if(0===a.indexOf(b))return a.substring(b.length,a.length)}return null},_setData:function(){var a=JSON.stringify(this.data);this._createCookie(a,365)},_clearData:function(){this._createCookie("",365)},_getData:function(){var a=this.hasStorage?null:this._readCookie();return a?JSON.parse(a):{}},toJSON:function(a){var b=a?this.get(a):this._getData();return b},toString:function(){return"["+Storm.name+" Storage]"}},c}();Storm.store=new Storage(Storage.TYPE.local),Storm.session=new Storage(Storage.TYPE.session),Events.extend=Cache.extend=DataContext.extend=Model.extend=Collection.extend=Comparator.extend=View.extend=Module.extend=Extend,Storm.noConflict=function(){return root.Storm=previousStorm,this},"undefined"!=typeof define&&define.amd&&define("Storm",[],function(){return Storm})}(this,_);
//# sourceMappingURL=StormJS-0.3.8a.min.map